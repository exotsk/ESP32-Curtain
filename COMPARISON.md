# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –î–æ –∏ –ü–æ—Å–ª–µ

## –ú–µ—Ç—Ä–∏–∫–∏ –ö–∞—á–µ—Å—Ç–≤–∞ –ö–æ–¥–∞

| –ê—Å–ø–µ–∫—Ç | –î–æ | –ü–æ—Å–ª–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|--------|-----|-------|-----------|
| **–í—Å–µ–≥–æ –°—Ç—Ä–æ–∫** | 232 | 294 | +27% (–≤–∫–ª—é—á–∞—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É) |
| **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ö–æ–¥** | 232 | ~220 | -5% (–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π) |
| **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏** | ~10 | ~70 | +600% |
| **–§—É–Ω–∫—Ü–∏–∏** | 5 | 5 | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–Ω–æ –ª—É—á—à–µ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã) |
| **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** | 12 | 4 | **-67%** |
| **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ö–æ–¥–∞** | 140 —Å—Ç—Ä–æ–∫ | 0 —Å—Ç—Ä–æ–∫ | **-100%** |
| **–ú–∞–≥–∏—á–µ—Å–∫–∏–µ –ß–∏—Å–ª–∞** | 15+ | 0 | **-100%** |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫** | –ù–µ—Ç | –ü–æ–ª–Ω–∞—è | **‚àû%** |

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –û—à–∏–±–∫–∏

### ‚ùå –î–æ (–°—Ç—Ä–æ–∫–∞ 141 - –û–®–ò–ë–ö–ê)
```cpp
void checkStep1 (void) {
  if (CurtHyster1 == true) {
    // –û–®–ò–ë–ö–ê: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è steps_from_zero2 –≤–º–µ—Å—Ç–æ steps_from_zero1!
    if (((steps_from_zero2 > STOPHYSTERESIS) && 
         (steps_from_zero2 < CURTMAXIMUM - STOPHYSTERESIS)) || 
        (steps_from_zero2 < -STOPHYSTERESIS) || 
        (steps_from_zero2 > CURTMAXIMUM + STOPHYSTERESIS)) {
      CurtHyster1 = false;
    }
  }
  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
}
```

**–í–ª–∏—è–Ω–∏–µ**: –õ–æ–≥–∏–∫–∞ –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–∞ –î–≤–∏–≥–∞—Ç–µ–ª—è 1 —á–∏—Ç–∞–ª–∞ –ø–æ–∑–∏—Ü–∏—é –î–≤–∏–≥–∞—Ç–µ–ª—è 2!

### ‚úÖ –ü–æ—Å–ª–µ (–°—Ç—Ä–æ–∫–∏ 232-266 - –ò–°–ü–†–ê–í–õ–ï–ù–û)
```cpp
void processStepperController(StepperController& ctrl) {
  int32_t currentPos = ctrl.stepper->currentPosition() / POSITION_SCALE;
  
  if (ctrl.hysteresisActive) {
    // –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –ö–∞–∂–¥—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ—é –ø–æ–∑–∏—Ü–∏—é
    if (((currentPos > STOP_HYSTERESIS) && 
         (currentPos < CURTAIN_MAXIMUM - STOP_HYSTERESIS)) ||
        (currentPos < -STOP_HYSTERESIS) || 
        (currentPos > CURTAIN_MAXIMUM + STOP_HYSTERESIS)) {
      ctrl.hysteresisActive = false;
    }
  }
  // ... —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±–æ–∏—Ö –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –û–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è!

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ö–æ–¥–∞

### –î–æ: –†–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã–µ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
```cpp
String clientId = "CURTAINS";
#define MQTT_ID "/CURTAINS/"
int switch_1_pin = 17;
int32_t got_int1;
int32_t got_int2;
bool CurtHyster1 = false;
char m_msg_buffer[MSG_BUFFER_SIZE];
const char *p_payload;
float got_float;
int i;
```
**–ü—Ä–æ–±–ª–µ–º—ã**:
- 12 –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- –ù–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
- –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤—è–∑–∏

### –ü–æ—Å–ª–µ: –û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```cpp
struct StepperController {
  AccelStepper* stepper;
  int32_t targetPosition;
  int32_t lastPublishedPosition;
  bool hysteresisActive;
  int upperLimitPin;
  int lowerLimitPin;
  const char* positionTopic;
};

StepperController controllers[2] = {
  {&stepper1, 0, 0, false, SWITCH_1_PIN, SWITCH_2_PIN, PUB_STEPS1},
  {&stepper2, 0, 0, false, SWITCH_3_PIN, SWITCH_4_PIN, PUB_STEPS2}
};

char msgBuffer[MSG_BUFFER_SIZE];
uint32_t lastReconnectAttempt = 0;
uint32_t reconnectDelay = MQTT_RECONNECT_DELAY_MS;
```
**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- 4 –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 67%)
- –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –≤–º–µ—Å—Ç–µ
- –õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –±–æ–ª—å—à–µ–≥–æ —á–∏—Å–ª–∞ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π
- –ß—ë—Ç–∫–æ–µ –≤–ª–∞–¥–µ–Ω–∏–µ

---

## –õ–æ–≥–∏–∫–∞ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è MQTT

### ‚ùå –î–æ: –ë–ª–æ–∫–∏—Ä—É—é—â–∞—è –∏ –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è
```cpp
void reconnect() {
  while (!client.connected()) {
    if (client.connect(clientId.c_str())) {
      client.subscribe(MQTT_STEP1);
      client.subscribe(MQTT_STEP2);
    } else {
      delay(6000);  // –ë–õ–û–ö–ò–†–£–ï–¢ –í–°–Å!
    }
  }
}

void loop() {
  if (!client.connected()) {
    reconnect();     // –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –∑–¥–µ—Å—å!
    delay(1000);     // –ï—â—ë –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞!
  }
  // ...
}
```

**–ü—Ä–æ–±–ª–µ–º—ã**:
- –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è 6-—Å–µ–∫—É–Ω–¥–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Ç—Ä–∞—Ç–∏—Ç –≤—Ä–µ–º—è
- –ù–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ —Å—Ç–∞—Ç—É—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### ‚úÖ –ü–æ—Å–ª–µ: –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∏ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è
```cpp
bool reconnect() {
  uint32_t now = millis();
  
  // –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
  if (now - lastReconnectAttempt < reconnectDelay) {
    return false;  // –ï—â—ë –Ω–µ –≤—Ä–µ–º—è
  }
  
  lastReconnectAttempt = now;
  Serial.print("Attempting MQTT connection...");
  
  String clientId = String(MQTT_CLIENT_ID) + "-" + String(random(0xffff), HEX);
  bool connected = client.connect(clientId.c_str());
  
  if (connected) {
    Serial.println("connected!");
    client.subscribe(MQTT_STEP1);
    client.subscribe(MQTT_STEP2);
    reconnectDelay = MQTT_RECONNECT_DELAY_MS;  // –°–±—Ä–æ—Å
    return true;
  } else {
    Serial.print("failed, rc=");
    Serial.println(client.state());
    
    // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 5—Å ‚Üí 10—Å ‚Üí 20—Å ‚Üí 30—Å
    reconnectDelay = min(reconnectDelay * 2, (uint32_t)MQTT_RECONNECT_MAX_DELAY_MS);
    return false;
  }
}

void loop() {
  if (!client.connected()) {
    reconnect();  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –µ—Å–ª–∏ –Ω–µ –≤—Ä–µ–º—è
  } else {
    client.loop();
  }
  // –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å!
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –°–∏—Å—Ç–µ–º–∞ –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∑—ã–≤—á–∏–≤–æ–π
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ç—å
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

---

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WiFi

### ‚ùå –î–æ: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –¶–∏–∫–ª
```cpp
void setup_wifi() {
  delay(100);
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);  // –ú–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞!
  }
  randomSeed(micros());
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–∏—Å—Ç–µ–º–∞ –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞–≤—Å–µ–≥–¥–∞, –µ—Å–ª–∏ WiFi –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

### ‚úÖ –ü–æ—Å–ª–µ: –¢–∞–π–º–∞—É—Ç –∏ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
```cpp
void setup_wifi() {
  Serial.println("Connecting to WiFi...");
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  
  uint32_t startAttemptTime = millis();
  
  while (WiFi.status() != WL_CONNECTED && 
         millis() - startAttemptTime < WIFI_CONNECT_TIMEOUT_MS) {
    delay(500);
    Serial.print(".");
    esp_task_wdt_reset();  // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å—Ç–æ—Ä–æ–∂–µ–≤–æ–π —Ç–∞–π–º–µ—Ä
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi connected!");
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nWiFi connection failed! Restarting...");
    delay(1000);
    ESP.restart();  // –ß–∏—Å—Ç–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- 20-—Å–µ–∫—É–Ω–¥–Ω—ã–π —Ç–∞–π–º–∞—É—Ç
- –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å–±–æ–µ
- –ó–∞—â–∏—Ç–∞ —Å—Ç–æ—Ä–æ–∂–µ–≤–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
- –ß—ë—Ç–∫–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å

---

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ö–æ–¥–∞

### ‚ùå –î–æ: –î–≤–µ –ü–æ—á—Ç–∏ –ò–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –§—É–Ω–∫—Ü–∏–∏ (–ø–æ 70 —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥–∞—è!)

```cpp
void checkStep1(void) {
  // 70 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–ª—è –î–≤–∏–≥–∞—Ç–µ–ª—è 1
  // —Å –æ—à–∏–±–∫–æ–π: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç steps_from_zero2!
}

void checkStep2(void) {
  // –¢–û–ß–ù–û –¢–ê–ö–ê–Ø –ñ–ï –õ–û–ì–ò–ö–ê —Å –¥—Ä—É–≥–∏–º–∏ –∏–º–µ–Ω–∞–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö!
  // –ï—â—ë 70 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞...
}
```

**–ü—Ä–æ–±–ª–µ–º—ã**:
- 140 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
- –û—à–∏–±–∫–∞ –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ (checkStep1), –Ω–æ –Ω–µ –≤ –¥—Ä—É–≥–æ–π
- –î–≤–æ–π–Ω–æ–µ –±—Ä–µ–º—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
- –õ–µ–≥–∫–æ –≤–Ω–µ—Å—Ç–∏ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

### ‚úÖ –ü–æ—Å–ª–µ: –ï–¥–∏–Ω–∞—è –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –§—É–Ω–∫—Ü–∏—è (35 —Å—Ç—Ä–æ–∫)

```cpp
void processStepperController(StepperController& ctrl) {
  int32_t currentPos = ctrl.stepper->currentPosition() / POSITION_SCALE;
  
  // –õ–æ–≥–∏–∫–∞ –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–∞
  if (ctrl.hysteresisActive) {
    if (((currentPos > STOP_HYSTERESIS) && 
         (currentPos < CURTAIN_MAXIMUM - STOP_HYSTERESIS)) ||
        (currentPos < -STOP_HYSTERESIS) || 
        (currentPos > CURTAIN_MAXIMUM + STOP_HYSTERESIS)) {
      ctrl.hysteresisActive = false;
    }
  } else {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ü–µ–≤–∏–∫–æ–≤
    if (digitalRead(ctrl.upperLimitPin) == LOW) {
      ctrl.stepper->stop();
      ctrl.stepper->disableOutputs();
      ctrl.stepper->setCurrentPosition(CURTAIN_MAXIMUM * POSITION_SCALE);
      ctrl.hysteresisActive = true;
    }
    if (digitalRead(ctrl.lowerLimitPin) == LOW) {
      ctrl.stepper->stop();
      ctrl.stepper->disableOutputs();
      ctrl.stepper->setCurrentPosition(0);
      ctrl.hysteresisActive = true;
    }
  }
  
  // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏
  if (currentPos != ctrl.lastPublishedPosition) {
    ctrl.lastPublishedPosition = currentPos;
    snprintf(msgBuffer, MSG_BUFFER_SIZE, "%d", currentPos);
    client.publish(ctrl.positionTopic, msgBuffer, true);
  }
  
  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–µ–º
  if (ctrl.targetPosition != ctrl.stepper->currentPosition()) {
    ctrl.stepper->run();
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
processStepperController(controllers[0]);  // –î–≤–∏–≥–∞—Ç–µ–ª—å 1
processStepperController(controllers[1]);  // –î–≤–∏–≥–∞—Ç–µ–ª—å 2
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- 100% —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º
- –ü–æ–ª–æ–≤–∏–Ω–∞ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

---

## –í–∞–ª–∏–¥–∞—Ü–∏—è –í–≤–æ–¥–∞

### ‚ùå –î–æ: –ë–µ–∑ –í–∞–ª–∏–¥–∞—Ü–∏–∏
```cpp
void callback(char *topic, byte *payload, unsigned int length) {
  for (i = 0; i < length; i++) {
    m_msg_buffer[i] = payload[i];  // –†–∏—Å–∫ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞!
  }
  m_msg_buffer[i] = '\0';
  
  got_float = atof(p_payload);
  got_int1 = (int)got_float * 100;  // –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞!
  stepper1.moveTo(got_int1);
}
```

**–†–∏—Å–∫–∏**:
- –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–∞, –µ—Å–ª–∏ payload > MSG_BUFFER_SIZE
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
- –ú–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—å –≤ –Ω–µ–≤–µ—Ä–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
- –¢–∏—Ö–∏–µ —Å–±–æ–∏

### ‚úÖ –ü–æ—Å–ª–µ: –ü–æ–ª–Ω–∞—è –í–∞–ª–∏–¥–∞—Ü–∏—è
```cpp
void callback(char* topic, byte* payload, unsigned int length) {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã payload
  if (length >= MSG_BUFFER_SIZE) {
    Serial.println("Error: Payload too large");
    return;
  }
  
  // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
  for (unsigned int i = 0; i < length; i++) {
    msgBuffer[i] = payload[i];
  }
  msgBuffer[length] = '\0';
  
  // –†–∞–∑–±–æ—Ä –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
  float position = atof(msgBuffer);
  int32_t targetSteps = (int32_t)(position * POSITION_SCALE);
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
  if (targetSteps < 0 || targetSteps > CURTAIN_MAXIMUM * POSITION_SCALE) {
    Serial.print("Error: Position out of range: ");
    Serial.println(targetSteps);
    return;
  }
  
  // –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –¥–≤–∏–≥–∞—Ç–µ–ª—é
  if (strcmp(topic, MQTT_STEP1) == 0) {
    controllers[0].targetPosition = targetSteps;
    controllers[0].stepper->moveTo(targetSteps);
    Serial.print("Stepper 1 -> ");
    Serial.println(position);
  }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ä–µ–∂–∏–º—ã –æ—Ç–∫–∞–∑–∞

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ì–ª–∞–≤–Ω–æ–≥–æ –¶–∏–∫–ª–∞

### ‚ùå –î–æ: –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ó–∞–¥–µ—Ä–∂–∫–∏
```cpp
void loop() {
  if (!client.connected()) {
    reconnect();   // –ë–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–∞ 6+ —Å–µ–∫—É–Ω–¥!
    delay(1000);   // –ï—â—ë –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–µ –≤—Ä–µ–º—è!
  }
  checkStep1();    // –°–ª–æ–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
  checkStep2();    // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–ª–æ–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
  client.loop();
}
```

**–ó–∞–¥–µ—Ä–∂–∫–∞**: –î–æ 7+ —Å–µ–∫—É–Ω–¥ –Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é —Ü–∏–∫–ª–∞!

### ‚úÖ –ü–æ—Å–ª–µ: –û—Ç–∑—ã–≤—á–∏–≤—ã–π –∏ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π
```cpp
void loop() {
  esp_task_wdt_reset();
  
  if (WiFi.status() != WL_CONNECTED) {
    setup_wifi();  // –° —Ç–∞–π–º–∞—É—Ç–æ–º
  }
  
  if (!client.connected()) {
    reconnect();  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
  } else {
    client.loop();
  }
  
  processStepperController(controllers[0]);  // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
  processStepperController(controllers[1]);  // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
  
  yield();  // –ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å
}
```

**–ó–∞–¥–µ—Ä–∂–∫–∞**: < 100–º—Å –æ–±—ã—á–Ω–æ, —Å–∏—Å—Ç–µ–º–∞ –≤—Å–µ–≥–¥–∞ –æ—Ç–∑—ã–≤—á–∏–≤–∞!

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ü–∞–º—è—Ç–∏

### –î–æ
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ**: 12 –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- **–û–±—ä–µ–∫—Ç—ã String**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
- **–†–∞–∑–º–µ—Ä –∫–æ–¥–∞**: 232 —Å—Ç—Ä–æ–∫–∏

### –ü–æ—Å–ª–µ
- **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ**: 4 –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (-67%)
- **–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ String**: –í—Å–µ `const char*`
- **–†–∞–∑–º–µ—Ä –∫–æ–¥–∞**: 294 —Å—Ç—Ä–æ–∫–∏ (+27%, –Ω–æ –≤–∫–ª—é—á–∞—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫–æ–¥**: ~220 —Å—Ç—Ä–æ–∫ (-5%)

---

## –ò—Ç–æ–≥–æ–≤–∞—è –°–≤–æ–¥–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|-----------|-----|-------|-----------|
| **–û—à–∏–±–∫–∏** | 1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è | 0 | ‚úÖ **100%** |
| **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ö–æ–¥–∞** | 140 —Å—Ç—Ä–æ–∫ | 0 | ‚úÖ **100%** |
| **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** | 12 | 4 | ‚úÖ **67%** |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫** | 0% | 100% | ‚úÖ **‚àû%** |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è | –ü–æ–ª–Ω–∞—è | ‚úÖ **600%** |
| **–ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ó–∞–¥–µ—Ä–∂–∫–∏** | 7+ —Å–µ–∫—É–Ω–¥ | 0 —Å–µ–∫—É–Ω–¥ | ‚úÖ **100%** |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è –í–≤–æ–¥–∞** | –ù–µ—Ç | –ü–æ–ª–Ω–∞—è | ‚úÖ **‚àû%** |
| **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** | –ë–∞–∑–æ–≤–∞—è | –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è | ‚úÖ **‚àû%** |
| **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** | –°–ª–æ–∂–Ω–∞—è | –ü—Ä–æ—Å—Ç–∞—è | ‚úÖ **–í—ã—Å–æ–∫–∞—è** |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è | –û—Ç–ª–∏—á–Ω–∞—è | ‚úÖ **–í—ã—Å–æ–∫–∞—è** |

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è:
- üêõ **–ë–µ–∑ –æ—à–∏–±–æ–∫** - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
- üöÄ **–ë—ã—Å—Ç—Ä–µ–µ** - –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è, –æ—Ç–∑—ã–≤—á–∏–≤–∞—è
- üõ°Ô∏è **–ù–∞–¥—ë–∂–Ω–µ–µ** - –°—Ç–æ—Ä–æ–∂–µ–≤–æ–π —Ç–∞–π–º–µ—Ä, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- üìù **–õ—É—á—à–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞** - –Ø—Å–Ω–∞—è, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è
- üéØ **–ì–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É** - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- üìà **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è** - –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å

**–ò—Ç–æ–≥**: –¢–∞ –∂–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è!
